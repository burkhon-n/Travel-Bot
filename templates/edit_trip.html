<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Edit Trip - {{ trip.name }}</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --tg-theme-bg-color: #ffffff;
      --tg-theme-text-color: #000000;
      --tg-theme-hint-color: #999999;
      --tg-theme-link-color: #2481cc;
      --tg-theme-button-color: #2481cc;
      --tg-theme-button-text-color: #ffffff;
      --tg-theme-secondary-bg-color: #f4f4f5;
      
      --primary: #2563eb;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg: #f8fafc;
      --surface: #ffffff;
      --text: #0f172a;
      --text-muted: #64748b;
      --border: #e2e8f0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--tg-theme-bg-color, var(--bg));
      color: var(--tg-theme-text-color, var(--text));
      min-height: 100vh;
      padding: 0;
      margin: 0;
      -webkit-font-smoothing: antialiased;
    }
    
    .header {
      background: var(--tg-theme-button-color, var(--primary));
      color: var(--tg-theme-button-text-color, #fff);
      padding: 20px 16px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    
    .header h1 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .header .subtitle {
      font-size: 13px;
      opacity: 0.9;
    }
    
    .container {
      padding: 16px;
      max-width: 600px;
      margin: 0 auto;
      padding-bottom: 80px;
    }
    
    .form-section {
      background: var(--tg-theme-secondary-bg-color, var(--surface));
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group:last-child {
      margin-bottom: 0;
    }
    
    label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--tg-theme-text-color, var(--text));
    }
    
    .label-hint {
      font-size: 12px;
      font-weight: 400;
      color: var(--tg-theme-hint-color, var(--text-muted));
      margin-left: 4px;
    }
    
    input, textarea {
      width: 100%;
      padding: 12px;
      font-size: 15px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--tg-theme-bg-color, var(--surface));
      color: var(--tg-theme-text-color, var(--text));
      font-family: inherit;
    }
    
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    input:focus, textarea:focus {
      outline: none;
      border-color: var(--tg-theme-button-color, var(--primary));
    }
    
    .buttons {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--tg-theme-bg-color, var(--surface));
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px;
    }
    
    .btn {
      flex: 1;
      padding: 14px 20px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    
    .btn:active {
      opacity: 0.7;
    }
    
    .btn-primary {
      background: var(--tg-theme-button-color, var(--success));
      color: var(--tg-theme-button-text-color, #fff);
    }
    
    .btn-secondary {
      background: var(--tg-theme-secondary-bg-color, #e5e7eb);
      color: var(--tg-theme-text-color, var(--text));
    }
    
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
    }
    
    .alert-success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #10b981;
    }
    
    .alert-error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #ef4444;
    }
    
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>‚úèÔ∏è Edit Trip</h1>
    <div class="subtitle">{{ trip.name }}</div>
  </div>
  
  <div class="container">
    <div id="alert" class="alert hidden"></div>
    
    <form id="editForm">
      <div class="form-section">
        <div class="form-group">
          <label for="name">Trip Name</label>
          <input type="text" id="name" name="name" value="{{ trip.name }}" required>
        </div>
        
        <div class="form-group">
          <label for="price">
            Price (UZS)
            <span class="label-hint">Total cost per person</span>
          </label>
          <input type="number" id="price" name="price" value="{{ trip.price }}" required min="0" step="1000">
        </div>
        
        <div class="form-group">
          <label for="participant_limit">
            Participant Limit
            <span class="label-hint">Leave empty for unlimited</span>
          </label>
          <input type="number" id="participant_limit" name="participant_limit" value="{{ trip.participant_limit or '' }}" min="1">
        </div>
      </div>
      
      <div class="form-section">
        <div class="form-group">
          <label for="card_info">
            Payment Info
            <span class="label-hint">Card number or payment instructions</span>
          </label>
          <textarea id="card_info" name="card_info" placeholder="e.g., Card: 8600 1234 5678 9012">{{ trip.card_info or '' }}</textarea>
        </div>
        
        <div class="form-group">
          <label for="agreement_text">
            Terms & Agreement
            <span class="label-hint">Important rules and requirements</span>
          </label>
          <textarea id="agreement_text" name="agreement_text" placeholder="Trip terms and conditions...">{{ trip.agreement_text or '' }}</textarea>
        </div>
      </div>
    </form>
  </div>
  
  <div class="buttons">
    <button type="button" class="btn btn-secondary" onclick="goBack()">Cancel</button>
    <button type="submit" form="editForm" class="btn btn-primary" id="saveBtn">üíæ Save Changes</button>
  </div>
  
  <script>
    const tg = window.Telegram?.WebApp;
    
    // Initialize Telegram WebApp
    if (tg) {
      tg.ready();
      tg.expand();
      tg.enableClosingConfirmation();
    }
    
    function showAlert(message, type = 'success') {
      const alert = document.getElementById('alert');
      alert.textContent = message;
      alert.className = `alert alert-${type}`;
      alert.classList.remove('hidden');
      
      setTimeout(() => {
        alert.classList.add('hidden');
      }, 3000);
    }
    
    function goBack() {
      if (tg) {
        tg.close();
      } else {
        window.history.back();
      }
    }
    
    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const saveBtn = document.getElementById('saveBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = '‚è≥ Saving...';
      
      try {
        const formData = new FormData(e.target);
        const data = {
          name: formData.get('name'),
          price: parseInt(formData.get('price')),
          participant_limit: formData.get('participant_limit') || null,
          card_info: formData.get('card_info'),
          agreement_text: formData.get('agreement_text'),
        };
        
        const tgUserId = tg?.initDataUnsafe?.user?.id;
        
        const response = await fetch(`/admin/api/trip/{{ trip.id }}/update`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(tgUserId && {'X-Telegram-Id': tgUserId.toString()})
          },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
          showAlert('‚úÖ Trip updated successfully!', 'success');
          tg?.HapticFeedback?.notificationOccurred('success');
          
          // Close after a short delay
          setTimeout(() => {
            if (tg) {
              tg.close();
            } else {
              window.location.href = `/admin/trip/{{ trip.id }}`;
            }
          }, 1000);
        } else {
          showAlert('‚ùå ' + result.message, 'error');
          tg?.HapticFeedback?.notificationOccurred('error');
        }
      } catch (error) {
        console.error('Error updating trip:', error);
        showAlert('‚ùå Failed to update trip', 'error');
        tg?.HapticFeedback?.notificationOccurred('error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'üíæ Save Changes';
      }
    });
  </script>
</body>
</html>
